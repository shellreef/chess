<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
<meta http-equiv="Content-type" content="text/html;charset=UTF-8">
<meta name="viewport" content="width=device-width; user-scalable=no">
<title>Drag and Drop</title>
<style>
.draggable { position: absolute; cursor: move; }

</style>
</head>
<body>
<script src="http://o.aolcdn.com/dojo/1.1.1/dojo/dojo.xd.js"></script>
<script>
/* TODO: pure JavaScript drag and drop, with the following features:
 * 1. No library dependence, lightweight
 * 2. Allow to either click and hold, or click to attach to cursor, then click again to drop
 *   -- detect if was released in a source container droppable
 * 3. Apply a "hoverclass" to active droppables when active
 * 4. revertbounds: If within the area and not dropped on a droppable, revert it to its
 *    source. If outside, then notate cursor with a puff of smoke, and when released,
 *    destroy() the object. Would use for dragging pieces off a chess board during setup.
 * 5. Support touch events, too!
 */
/* http://luke.breuer.com/tutorial/javascript-drag-and-drop-tutorial.aspx
 * http://www.quirksmode.org/js/dragdrop.html
 * http://www.sitepen.com/labs/code/iphone/events.html
 */


dojo.addOnLoad(function(){
    var nodes = {item: document.getElementById("item")};
    var DRAG = 
    {
        start_x: 0,
        start_y: 0,
        offset_x: 0,
        offset_y: 0,
        element: null,
        old_zindex: 0,
        ing: false  
    };

    function on_down(event)
    {
        var target;

        event = event || window.event;

        target = event.target !== undefined ? event.target : event.srcElement;

        DRAG.initial_x = event.clientX;
        DRAG.initial_y = event.clientY;

        DRAG.start_x = target.offsetLeft;
        DRAG.start_y = target.offsetTop;

        // Bring to front
        DRAG.old_zindex = target.style.zIndex;
        target.style.zIndex = 10000;

        // Capture mouse
        DRAG.element = target;
        document.onmousemove = on_move;
        document.onmouseup = on_up;

        // Prevent text selection
        document.body.focus();
        document.onselectstart = function() { return false; };
        target.ondragstart = function() { return false; };
        return false;
    }

    function on_move(event)
    {
        var element, new_x, new_y;
            
        event = event || window.event;

        element = DRAG.element;

        // Must have draggable class
        if (element.className.indexOf("draggable") == -1) {
            return;
        }

        new_x = event.clientX - DRAG.initial_x + DRAG.start_x;
        new_y = event.clientY - DRAG.initial_y + DRAG.start_y;

        // Drag
        element.style.left = new_x + "px";
        element.style.top = new_y + "px";

        return false;
    }

    function on_up()
    {
        if (DRAG.element === null) {
            return;
        }

        DRAG.element.style.zIndex = DRAG.old_zindex;
        document.onmousemove = null;
        document.onselectstart = null;
        DRAG.element.ondragstart = null;

        DRAG.element = null;
    }


    function touch(evt){
        for (var i = 0; i < evt.changedTouches.length; ++i) {
            var e = evt.changedTouches[i]; 

            var color, border;
            var target = e.target;

            if(target == nodes.item && !DRAG.ing){
                // Save the offset of the touch within the current note
                DRAG.ing = [e.pageX - dojo.style(nodes.item, "left"), e.pageY - dojo.style(nodes.item, "top")];
            }
        }
    }

    function touchend(evt){
        for (var i = 0; i < evt.changedTouches.length; ++i) {
            var e = evt.changedTouches[i];

            // Check to see if we've gone from a gesture back down to a touch
            if(e.target == nodes.item){
                if(evt.targetTouches.length == 1){
                    // If there was rotation, this number needs to be reset
                    DRAG.ing = [evt.targetTouches[0].pageX - dojo.style(nodes.item, "left"), evt.targetTouches[0].pageY - dojo.style(nodes.item, "top")];
                }else if(!evt.targetTouches.length){
                    // Great use of e.targeTouches, since releasing on finger that's part
                    // of a gesture over this node would trigger a touchend even though
                    // it could keep going
                    DRAG.ing = false;
                }
            }
        }
    }

    function touchmove(evt){
        evt.preventDefault();
        for (var i = 0; i < evt.changedTouches.length; ++i) {
            var e = evt.changedTouches[i];

            if (DRAG.ing && e.target == nodes.item){
                    // Move the node if we're in a state of dragging, but not resizing
                    nodes.item.style.left = e.pageX - DRAG.ing[0] + "px";
                    nodes.item.style.top = e.pageY - DRAG.ing[1] + "px";
            }
        }
    };

    document.onmousedown = on_down;
    document.ontouchmove = on_move;

    document.ontouchstart = touch;
    nodes.item.ontouchmove = touchmove;
    document.ontouchend = touchend;
});
</script>
</body>
<p><div class="draggable" style="background-color: blue; width: 10px; height: 10px; top: 0px; left: 0px"></div>
<p><div class="draggable" style="background-color: red; width: 10px; height: 10px; top: 0px; left: 20px"></div>
<div class="draggable" style="background-color: yellow; width: 10px; height: 10px"></div>
<div class="draggable" 
    style="background-color: grey;
    width: 15px;
    height: 15px;
    left: 40px;
    top: 40px;"
id="item"></div>
<div style="background-color: black; width: 10px; height: 10px; left: 20px; position: absolute"></div>
</body>
</html>
