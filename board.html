<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html lang="en">
<head>
<title>Chess</title>
<style>
img.piece
{ 
 border: none;
 margin: 0px;
}

img.black {}
img.white {}

img.rook {}
img.knight {}
img.bishop {}
img.queen {}
img.king {}
img.pawn {}

table.board
{
 border: 2px solid black;
 border-collapse: collapse; 	/* cellspacing=0 cellpadding=0 */

 /* Firefox: disable text selection when dragging */
 -moz-user-select: none;
}

td.square
{
 border-style: none;
 //border: 1px solid black;
 padding: 0em;
 margin: 0em;
 width: 53px;
 height: 53px;
}

td.hover 
{ 
 //border: 1px solid black;
 //background: url("images/wk.gif");
 background-color: blue !important;
}


/* Colors based on http://en.wikipedia.org/wiki/Chessboard
 * Useful site: http://www.cssdrive.com/imagepalette/index.php
 * Colors palette generator, get colors of an arbitrary image.
 *
 * Other colors to consider: http://chessos.com/, higher contrast
 *  http://chessteacher.110mb.com/, much lighter
 * But I like these, gives it a nice wooden feel. Could also
 * use green for a tournament-style board.
 */
td.white { background-color: #ffce9e; }
td.black { background-color: #d18b47; }

/* TODO: check out what colors Chess with Friends uses */
td.legal-move-white { background-color: #cf9e6e; }
td.legal-move-black { background-color: #a15b17; }


/* Would be cool to use CSS3 expressions to make the pattern, but they're not in
 * Firefox 3.0.8, maybe in Firefox 3.1. Safari has them though! 
 * If do this, would need to remember to shift nth-child per ranks. 
/*td:nth-child(2n) { background-color: green } */

</style>
<script src="http://www.google.com/jsapi"></script>
<script language="javascript">
google.load("prototype", "1.6.0.3");
google.load("scriptaculous", "1.8.2");

var game_state = {
	// Whose turn it is
	active_color: 'w',
	
	// Castling privileges
	white_castle_short: true,
	white_castle_long: true,
	black_castle_short: true,
	black_castle_long: true,
	enpassant_target: null,

	halfmove_clock: 0,	// Ply since last pawn advance / capture
	fullmove_number: 1,	// Increment after black moves
};	

google.setOnLoadCallback(function() {
	/* Safari & IE7: Disable text selection to stop interfering with dragging */
	enableDocumentSelection(false);	
	
	//load_fen("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1");
	//load_fen("rnbqkbnr/pp1ppppp/8/2p5/4P3/8/PPPP1PPP/RNBQKBNR w KQkq c6 0 2");
	load_fen("rnbqkbnr/pp1ppppp/8/2p5/4P3/5N2/PPPP1PPP/RNBQKB1R b KQkq - 1 2");

	// TODO: only add droppables for valid squares?
	$$(".square").each(function(square) {
		Droppables.add(square, {accept:"piece", onDrop: move_dropped_piece, hoverclass: 'hover'});
	});
});

// Set the active color to white or black, or toggle it
function set_turn(color)
{
	var new_color, active_pieces;

	assert(color == "white" || color == "black" || color == "toggle", "set_turn(" + color + "): invalid color");

	if (color == "toggle") {
		new_color = (game_state["active_color"] == "white") ? "black" : "white";
	} else {
		new_color = color;
	}


	//if (new_color == "w") {
	//new Draggable(piece, {revert: true, starteffect: undefined, endeffect: undefined });

	$("status").innerHTML = ucfirst(new_color) + "'s Turn";


	game_state["active_color"] = new_color;
}

//// BOARD FUNCTIONS

// Move a piece
function move_dropped_piece(piece, square, event)
{	
	console.log(piece);
	console.log(square);

	// TODO: do some cool effects when a piece is captured, but not too cool
	//new Effect.Squish(square.firstChild);

	// Capture piece on destination square
	while (square.firstChild)
		square.removeChild(square.firstChild);

	// Move to new square
	if (piece.parentNode)
		piece.parentNode.removeChild(piece);

	square.appendChild(piece);

	// TODO: only toggle if move was successful, or only have droppables for
	// legal moves?
	set_turn("toggle");
}

// Load board state
function load_fen(fen)
{
	var parts, castling;

	parts = fen.split(" ");
	load_starting_position(parts[0]);

	assert(/^[wb]$/.test(parts[1]), "load_fen(" + fen + "): bad active color: " + parts[1]);
	set_turn({w:"white", b:"black"}[parts[1]]);

	castling = parts[2];
	game_state["white_castle_short"] = /K/.test(castling);
	game_state["white_castle_long"] = /Q/.test(castling);
	game_state["black_castle_short"] = /k/.test(castling);
	game_state["black__castle_long"] = /q/.test(castling);

	if (parts[3] == "-") {
		game_state["enpassant_target"] = null;
	} else {
		game_state["enpassant_target"] = parts[3]; // for sq()
	}

	game_state["halfmove_clock"] = parseInt(parts[4]);
	game_state["fullmove_number"] = parseInt(parts[5]);
}

// Load starting position in FEN. Example, at beginning of game:
// rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR
function load_starting_position(fen)
{
	var i, x, y, code;

	// Note that ranks and files internally are represented here by
	// x,y coordinates, so a8 = 0,0. That is where FEN starts.
	x = y = 0;
	for (i = 0; i < fen.length; ++i) {
		code = fen.charAt(i);
		if (/[a-zA-Z]/.test(code)) {
			sq(x, y).appendChild(new_piece(code));
			++x;
		} else if (code == "/") {
			x = 0;
			++y;
		} else if (/[0-9]/.test(code)) {
			x += code.charCodeAt(0) - "0".charCodeAt(0);
		} else if (code == " ") {
			break;
		} else {
			assert("load_starting_position(" + fen + "): unknown code: " + code);
		}
	}
}

//// PIECE FUNCTIONS

// Create a new piece or pawn, given the name in
// Forsyth-Edwards Notation, for example:
//  r = black rook, R = white rook, N = white knight
function new_piece(name)
{
	var color, filename, piece, piece_type, classes;

	classes = "piece";	

	// In FEN, uppercase=white, lower=black
	if (/^[RNBQKP]/.test(name)) {
		color = "w";
		classes += " white";
	} else if (/^[rnbqkp]/.test(name)) {
		color = "b";
		classes += " black";
	} else {
		assert("new_piece(" + name + "): unrecognized");
	}
	piece_type = name.toLowerCase();

	classes += " " + {r: 'rook', n: 'knight', b: 'bishop', q: 'queen', k: 'king', p: 'pawn'}[piece_type];

	// TODO: pngs
	filename = 'images/' + color + piece_type + '.gif';


	piece = Builder.node('img', {'src': filename, 'class': classes});

	// Highlight/unhighlight legal moves on mouse over, like Chess with Friends.
	// Yahoo Games does this too, but uses a yellow outline.
	Event.observe(piece, 'mouseover', function() {
			moves_for(piece).each(function(square) {
				if (square.hasClassName("white"))
					square.addClassName("legal-move-white");
				else
					square.addClassName("legal-move-black");

			});
		}
	);
	Event.observe(piece, 'mouseout', function() 
		{
			moves_for(piece).each(function(square) { 
				square.removeClassName("legal-move-white");
				square.removeClassName("legal-move-black");
			});
		}
	);

	// TODO: instead of reverting, check if valid move
	// TODO: Figure out how to fix how the draggable jumps, by the amount it moved,
	// when being dropped. http://www.tutorialspoint.com/cgi-bin/practice.cgi?file=scriptaculous_12 
	// does this too. reverteffect defaults to Effect.Move, and it reverts back to *something*,
	// figure this point.
	new Draggable(piece, {revert: true, starteffect: undefined, endeffect: undefined });

	return piece;
}

// Get the legal moves for a piece
function moves_for(piece)
{
	return new Array(sq("a1"), sq("a2"), sq("f7"));
	// TODO
}

//// SQUARE FUNCTIONS

// Get a square cell, given location in either
// - algebraic notation (example: "a8", one argument), or
// - x,y coordinates, (equivalent example: 0,0)
function sq(code, extra)
{
	var rank, file;

	if (extra !== undefined) {
		file = code;
		rank = extra;
	} else {
		file = code.charCodeAt(0) - "a".charCodeAt(0);
		rank = 8 - (code.charCodeAt(1) - "0".charCodeAt(0));
	}

	assert(rank >= 0 && rank <= 7, "sq(" + code + ", " + extra + "): bad rank: " + rank);
	assert(file >= 0 && file <= 7, "sq(" + code + ", " + extra + "): bad file: " + file);

	return $('board-body').childNodes[rank].childNodes[file];
}

//// LOW-LEVEL FUNCTIONS

// Uppercase first character, like in Perl
function ucfirst(s)
{
	return s.substring(0, 1).toUpperCase() + s.substring(1);
}

// Based on http://aymanh.com/9-javascript-tips-you-may-not-know
function AssertException(message) { this.message = message; }
AssertException.prototype.toString = function() {
	return 'AssertException: ' + this.message;
};

function assert(expression, message)
{
	if (!expression) 
		throw new AssertException(message);
}

// Based on http://tech.hickorywind.org/articles/2008/10/24/turning-off-text-selection-in-javascript
function enableDocumentSelection(enable) {
  if(enable) {
    document.onselectstart = _original_onselectstart;
  }
  else {
    _original_onselectstart = document.onselectstart;
    document.onselectstart = function() { return false; }
  }
}


</script>
</head>

<body>
<table id="outer">
 <tr>
  <td>
<table class="board" id="board">
<tbody id="board-body"
><tr
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
></tr
><tr
 ><td id=y class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
></tr
><tr
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
></tr
><tr
 ><td id=y class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
></tr
><tr
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
></tr
><tr
 ><td id=y class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
></tr
><tr
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
  ><td class="white square"></td
  ><td class="black square"></td
></tr
><tr
 ><td id=y class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
 ><td class="black square"></td
 ><td class="white square"></td
></tr
></tbody
></table>


 </td><td valign="top">
  <p id="status"></p>
 </td>
</tr>
</table>

</body>
</html>
